<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Name Similarity Finder</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    input, button { margin: 0.5rem 0; padding: 0.5rem; width: 100%; }
    #results { margin-top: 1rem; }
    table { width: 100%; border-collapse: collapse; }
    td, th { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    #spinner { display: none; margin: 1rem 0; text-align: center; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Name Similarity Finder</h1>

  <div id="spinner">Loading database...</div>

  <input type="text" id="inputNames" placeholder="Enter names, comma-separated (e.g. Alice, John)" />
  <button onclick="findSimilarNames()">Find Similar Names</button>

  <div id="results"></div>

  <script>
    let db;

    async function initDb() {
      document.getElementById("spinner").style.display = "block";
      const SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
      });
      const response = await fetch("assets/names_normalized.db");
      const buffer = await response.arrayBuffer();
      db = new SQL.Database(new Uint8Array(buffer));
      document.getElementById("spinner").style.display = "none";
    }

    initDb();

    function findSimilarNames() {
      if (!db) {
        alert("Database is not loaded yet.");
        return;
      }
      const input = document.getElementById("inputNames").value;
      const names = input.split(",").map(n => n.trim().toLowerCase()).filter(Boolean);
      if (names.length === 0) {
        alert("Please enter at least one name.");
        return;
      }

      // Construct average vector from input names
      const selectVectorSQL = `
        SELECT * FROM names_normalized WHERE lower(name) IN (${names.map(() => '?').join(',')})
      `;
      const inputRows = db.exec(selectVectorSQL, names)[0];
      if (!inputRows || inputRows.values.length === 0) {
        alert("No matching names found in database.");
        return;
      }

      const floatCols = inputRows.columns.filter(c => c.startsWith("year_"));

      // Compute average vector
      const vectorSum = new Array(floatCols.length).fill(0);
      for (const row of inputRows.values) {
        floatCols.forEach((col, i) => {
          const val = row[inputRows.columns.indexOf(col)] || 0;
          vectorSum[i] += val;
        });
      }
      const avgVector = vectorSum.map(v => v / inputRows.values.length);

      // Build SQL for finding distances
      const distanceExpr = floatCols.map((col, i) => `
        CASE WHEN ${col} IS NULL THEN 0 ELSE pow(${col} - ${avgVector[i]}, 2) END
      `).join(" + ");

      const nearestSQL = `
        SELECT name, sqrt(${distanceExpr}) AS distance
        FROM names_normalized
        WHERE name NOT IN (${names.map(() => '?').join(',')})
        ORDER BY distance ASC
        LIMIT 10;
      `;

      const results = db.exec(nearestSQL, names)[0];
      if (!results || results.values.length === 0) {
        document.getElementById("results").innerHTML = "<p>No similar names found.</p>";
        return;
      }

      // Show results
      const rows = results.values.map(row => `<tr><td>${row[0]}</td><td>${row[1].toFixed(4)}</td></tr>`).join("");
      document.getElementById("results").innerHTML = `
        <h2>Nearest Names</h2>
        <table>
          <thead><tr><th>Name</th><th>Distance</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }
  </script>
</body>
</html>
